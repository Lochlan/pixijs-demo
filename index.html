
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>pixi.js tarot card demo</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000000;
        }
    </style>
    <script src="https://code.jquery.com/jquery-2.1.1.js"></script>
    <script src="pixi.js"></script>
    <script src="tween.js"></script>
    <script src="simple-swipe.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>

</head>
<body id="body">
    <script>
        function getFanPosition(a_deg, r, cx, cy) {
            var a = (a_deg) * Math.PI / 180;
            return {
                a: a + Math.PI / 2, // Add 90Â° so card will point out
                x: cx + r * Math.cos(a),
                y: cy + r * Math.sin(a),
            };
        }

        var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|OperaAndroid|Opera Mini/i.test(navigator.userAgent);

        var spreads = {
            desktop: {
                // size: 300 x 375 (only accounts for middle of cards)
                celtic_cross: [
                    {
                        x: 100,
                        y: 175,
                        a: 0,
                    },
                    {
                        x: 100,
                        y: 175,
                        a: Math.PI / 2,
                    },
                    {
                        x: 100,
                        y: 300,
                        a: 0,
                    },
                    {
                        x: 0,
                        y: 175,
                        a: 0,
                    },
                    {
                        x: 100,
                        y: 50,
                        a: 0,
                    },
                    {
                        x: 200,
                        y: 175,
                        a: 0,
                    },
                    {
                        x: 300,
                        y: 375,
                        a: 0,
                    },
                    {
                        x: 300,
                        y: 250,
                        a: 0,
                    },
                    {
                        x: 300,
                        y: 125,
                        a: 0,
                    },
                    {
                        x: 300,
                        y: 0,
                        a: 0,
                    },
                ]
            },
            mobile : {
                // size: 320 x 480 max
                celtic_cross: [
                    {
                        x: 160,
                        y: 170,
                        a: 0,
                    },
                    {
                        x: 160,
                        y: 170,
                        a: Math.PI / 2,
                    },
                    {
                        x: 160,
                        y: 290,
                        a: 0,
                    },
                    {
                        x: 65,
                        y: 170,
                        a: 0,
                    },
                    {
                        x: 160,
                        y: 50,
                        a: 0,
                    },
                    {
                        x: 255,
                        y: 170,
                        a: 0,
                    },
                    {
                        x: 43,
                        y: 410,
                        a: 0,
                    },
                    {
                        x: 121,
                        y: 410,
                        a: 0,
                    },
                    {
                        x: 199,
                        y: 410,
                        a: 0,
                    },
                    {
                        x: 277,
                        y: 410,
                        a: 0,
                    },
                ]
            }
        }

        var CANVAS_WIDTH = isMobile ? window.innerWidth : 800;
        var CANVAS_HEIGHT = isMobile ? window.innerHeight : 800;

        var CARD_FAN_X = CANVAS_WIDTH / 2;
        var CARD_FAN_Y = isMobile ? CANVAS_HEIGHT : CANVAS_HEIGHT / 2;
        var CARD_FAN_R = 300;
        var SPREAD_X = isMobile ? 0 : 250;
        var SPREAD_Y = isMobile ? 10 : 300;

        var spread = isMobile ? spreads.mobile.celtic_cross : spreads.desktop.celtic_cross;
        var stage = new PIXI.Stage(0xff0000, true);
        var renderer = new PIXI.WebGLRenderer(CANVAS_WIDTH, CANVAS_HEIGHT); //autoDetectRenderer(400, 300);

        var deck = [];
        var deferreds = [];
        var card;
        var i;
        var simpleSwipe;

        var textures = { ghost: PIXI.Texture.fromImage('decks/universal_waite/ghost.jpg') };
        for (i = 0; i <= 77; i++) {
            textures[i] = PIXI.Texture.fromImage('decks/universal_waite/' + i + '.jpg');
        }

        // set up cards
        for (i = 0; i <= 77; i++) {
            // Cards begin life face down in the middle of the canvas
            card = new PIXI.Sprite(textures.ghost);
            card.anchor.x = 0.5;
            card.anchor.y = 0.5;
            card.position.x = CANVAS_WIDTH / 2;
            card.position.y = CANVAS_HEIGHT / 2 - (0.25 * i);
            card.setInteractive(true);
            card.click = card.tap = function () {
                deck.forEach(function (card) {
                    card.tweenDeckToFan();
                });
            };

            card.d = new $.Deferred();
            card.number = i;
            card.faceUp = false;
            card.flip = function () {
                this.faceUp = !this.faceUp;
                this.setTexture(this.faceUp ? textures[this.number] : textures.ghost);
            };
            card.moveToTop = function () {
                var parent = this.parent;
                parent.removeChild(this);
                parent.addChildAt(this, parent.children.length);
            };

            card.tweenDeckToFan = function () {
                var self = this;
                var a_deg = (deck.indexOf(self) / (deck.length - 1)) * 180;
                var endpos = getFanPosition(a_deg - 180, CARD_FAN_R, CARD_FAN_X, CARD_FAN_Y);

                var tween = new TWEEN.Tween({
                        x: self.position.x,
                        y: self.position.y,
                        a: self.rotation,
                    })
                    .to({
                        x: endpos.x,
                        y: endpos.y,
                        a: endpos.a,
                    }, 500)
                    .easing(TWEEN.Easing.Cubic.InOut)
                    .onUpdate(function (done) {
                        self.position.x = this.x;
                        self.position.y = this.y;
                        self.rotation = this.a;
                    })
                    .onComplete(function () {
                        self.click = self.tap = self.tweenFanToSpread;
                        self.d.resolve();
                    })
                    .start();
            };
            card.tweenFanToSpread = function () {
                var self = this;
                var pos = spread.shift();
                var tween;

                if (pos === undefined) {
                    return;
                }

                tween = new TWEEN.Tween({
                        x: self.position.x,
                        y: self.position.y,
                        a: self.rotation,
                    })
                    .to({
                        x: pos.x + SPREAD_X,
                        y: pos.y + SPREAD_Y,
                        a: pos.a,
                    }, 500)
                    .easing(TWEEN.Easing.Cubic.InOut)
                    .onStart(function () {
                        self.click = self.tap = undefined;
                    })
                    .onUpdate(function (done) {
                        if (done > 0.5 && self.faceUp === false) {
                            self.moveToTop();
                        }
                        self.position.x = this.x;
                        self.position.y = this.y;
                        self.rotation = this.a;
                    }).onComplete(function () {
                        self.flip();
                    })
                    .start();
            };

            deferreds.push(card.d);
            deck.push(card);
            stage.addChild(card);
        }

        $.when.apply(null, deferreds).done(function() {
            console.log('deferreds done');

            var cardRotationOffset = 0; // mobile only

            if (isMobile) {
                simpleSwipe = new SimpleSwipe("body", function (swipe, el) {
                    console.log(swipe.directionCurrent, swipe.lengthCurrent, cardRotationOffset);
                    if (swipe.directionCurrent === 'left') {
                        cardRotationOffset -= 0.5 * (swipe.lengthCurrent >=3 ? 3 : swipe.lengthCurrent);
                    } else if (swipe.directionCurrent === 'right') {
                        cardRotationOffset += 0.5 * (swipe.lengthCurrent >=3 ? 3 : swipe.lengthCurrent);
                    }

                    deck.forEach(function (card) {
                        a_deg = ((deck.indexOf(card) + cardRotationOffset) / (deck.length - 1)) * 180;
                        endpos = getFanPosition(a_deg - 180, CARD_FAN_R, CARD_FAN_X, CARD_FAN_Y);
                        card.position.x = endpos.x;
                        card.position.y = endpos.y;
                        card.rotation = endpos.a;
                    });
                });
            }
        });


        document.body.appendChild(renderer.view);
        requestAnimFrame(animate);

        function animate(time) {
            renderer.render(stage);
            requestAnimationFrame(animate);
            TWEEN.update(time);
        }
    </script>

    </body>
</html>
