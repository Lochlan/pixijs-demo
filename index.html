
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <title>pixi.js tarot card demo</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000000;
        }
    </style>
    <script src="https://code.jquery.com/jquery-2.1.1.js"></script>
    <script src="pixi.js"></script>
    <script src="tween.js"></script>

</head>
<body id="body">
    <script>
        'use strict';

        function getFanPosition(a_deg, r, cx, cy) {
            var a = (a_deg) * Math.PI / 180;
            return {
                a: (a + Math.PI / 2) % (2 * Math.PI), // Add 90Â° so card will point out, use remainder operator to reduce card spinning
                x: cx + r * Math.cos(a),
                y: cy + r * Math.sin(a),
            };
        }

        var spreads = {
            desktop: {
                // size: 300 x 375 (only accounts for middle of cards)
                celtic_cross: [
                    {
                        x: 100,
                        y: 175,
                        a: 0,
                    },
                    {
                        x: 100,
                        y: 175,
                        a: Math.PI / 2,
                    },
                    {
                        x: 100,
                        y: 300,
                        a: 0,
                    },
                    {
                        x: 0,
                        y: 175,
                        a: 0,
                    },
                    {
                        x: 100,
                        y: 50,
                        a: 0,
                    },
                    {
                        x: 200,
                        y: 175,
                        a: 0,
                    },
                    {
                        x: 300,
                        y: 375,
                        a: 0,
                    },
                    {
                        x: 300,
                        y: 250,
                        a: 0,
                    },
                    {
                        x: 300,
                        y: 125,
                        a: 0,
                    },
                    {
                        x: 300,
                        y: 0,
                        a: 0,
                    },
                ],
            },
        };

        var CANVAS_WIDTH = 800;
        var CANVAS_HEIGHT = 800;
        var DECK_LENGTH = 77; // zero indexed
        var DECK_START_X = CANVAS_WIDTH / 2;
        var DECK_START_Y = CANVAS_HEIGHT / 2;
        var CARD_FAN_X = CANVAS_WIDTH / 2;
        var CARD_FAN_Y = CANVAS_HEIGHT / 2;
        var CARD_FAN_R = 300;
        var CARD_FAN_DEGREES = 180;
        var SPREAD_X = 250;
        var SPREAD_Y = 300;

        var spread = spreads.desktop.celtic_cross;
        var stage = new PIXI.Stage(0xffffff, true);
        var renderer = new PIXI.autoDetectRenderer(CANVAS_WIDTH, CANVAS_HEIGHT);

        var deck = [];
        var dfds = [];
        var card;
        var i;
        var simpleSwipe;
        var pile2StartIndex;

        var textures = { ghost: PIXI.Texture.fromImage('decks/universal_waite/ghost.jpg') };
        for (i = 0; i <= DECK_LENGTH; i++) {
            textures[i] = PIXI.Texture.fromImage('decks/universal_waite/' + i + '.jpg');
        }


        function Card(texture) {
            PIXI.Sprite.call(this, texture); // call super constructor.
            this.anchor.x = 0.5;
            this.anchor.y = 0.5;
            this.position.x = DECK_START_X;
            this.position.y = DECK_START_Y;
        }
        Card.prototype = Object.create(PIXI.Sprite.prototype);
        Card.prototype.constructor = Card;

        Card.prototype.tweenDeckToFan = function () {
            var self = this;
            var a_deg = (deck.indexOf(self) / (deck.length - 1)) * CARD_FAN_DEGREES;
            var positionInFan = getFanPosition(a_deg - 180, CARD_FAN_R, CARD_FAN_X, CARD_FAN_Y);

            var tween = new TWEEN.Tween({
                    x: self.position.x,
                    y: self.position.y,
                    a: self.rotation,
                })
                .to({
                    x: positionInFan.x,
                    y: positionInFan.y,
                    a: positionInFan.a,
                }, 500)
                .easing(TWEEN.Easing.Cubic.InOut)
                .onUpdate(function (done) {
                    self.position.x = this.x;
                    self.position.y = this.y;
                    self.rotation = this.a;
                })
                .onComplete(function () {
                    self.click = self.tap = null;
                    self.d.resolve();
                })
                .start();
        };

        // set up cards
        for (i = 0; i <= DECK_LENGTH; i++) {
            card = new Card(textures.ghost); // face down
            card.interactive = true;
            card.d = new $.Deferred();
            card.number = card.ordering = i;

            card.click = card.tap = function () {
                deck.forEach(function (card) {
                    card.tweenDeckToFan();
                });
            };

            dfds.push(card.d);
            deck.push(card);
            stage.addChild(card);
        }



        document.body.appendChild(renderer.view);
        requestAnimFrame(animate);

        function animate(time) {
            renderer.render(stage);
            requestAnimationFrame(animate);
            TWEEN.update(time);
        }
    </script>

    </body>
</html>
